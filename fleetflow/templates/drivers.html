{% extends 'base.html' %}
{% block title %}Driver Profiles{% endblock %}
{% block page_title %}Driver Performance & Safety Profiles{% endblock %}
{% block page_subtitle %}Compliance management, license tracking, and safety scores{% endblock %}

{% block topbar_actions %}
{% if can_write_drivers %}
<button class="btn btn-accent btn-sm" data-bs-toggle="modal" data-bs-target="#addDriverModal">
    <i class="bi bi-plus-lg me-1"></i>Add Driver
</button>
{% else %}
<span class="badge" style="background:rgba(148,163,184,0.15);color:var(--text-secondary);padding:6px 12px;border-radius:6px;font-size:0.75rem"><i class="bi bi-eye me-1"></i>Read Only</span>
{% endif %}
{% endblock %}

{% block content %}
<div class="row g-3">
    {% for d in drivers %}
    <div class="col-lg-4 col-md-6">
        <div class="card h-100" style="{% if d.license_expiry and (d.license_expiry - now.date()).days < 0 %}border-color:rgba(239,68,68,0.4){% elif d.license_expiry and (d.license_expiry - now.date()).days <= 30 %}border-color:rgba(245,158,11,0.4){% endif %}">
            <div class="card-body">
                <div class="d-flex align-items-start justify-content-between mb-3">
                    <div class="d-flex align-items-center gap-3">
                        <div style="width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:700;color:#000;flex-shrink:0">
                            {{ d.name[0].upper() }}
                        </div>
                        <div>
                            <div style="font-weight:700;font-size:0.95rem">{{ d.name }}</div>
                            <div style="font-size:0.75rem;color:var(--text-secondary)">{{ d.phone or d.email or 'No contact' }}</div>
                        </div>
                    </div>
                    {% set s = d.status %}
                    <span class="status-pill pill-{{ s.lower().replace(' ','-') }}">{{ s }}</span>
                </div>

                <!-- Stats -->
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div style="background:var(--bg-elevated);border-radius:8px;padding:10px;text-align:center">
                            <div class="mono" style="font-size:1.3rem;font-weight:700;color:var(--accent)">{{ d.trips_completed }}</div>
                            <div style="font-size:0.65rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px">Trips Done</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div style="background:var(--bg-elevated);border-radius:8px;padding:10px;text-align:center">
                            <div class="mono" style="font-size:1.3rem;font-weight:700;color:{% if d.safety_score >= 90 %}var(--success){% elif d.safety_score >= 70 %}var(--warning){% else %}var(--danger){% endif %}">{{ d.safety_score }}</div>
                            <div style="font-size:0.65rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px">Safety Score</div>
                        </div>
                    </div>
                </div>

                <!-- License info -->
                <div style="font-size:0.78rem;padding:8px 10px;border-radius:6px;background:var(--bg-elevated);margin-bottom:12px">
                    <div class="d-flex justify-content-between">
                        <span style="color:var(--text-secondary)">License #</span>
                        <span class="mono">{{ d.license_number }}</span>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <span style="color:var(--text-secondary)">Expires</span>
                        {% set today = now.strftime('%Y-%m-%d') if now is defined else '' %}
                        {% set expiry_str = d.license_expiry.strftime('%Y-%m-%d') if d.license_expiry else '' %}
                        {% set days_left = (d.license_expiry - now.date()).days if d.license_expiry and now is defined else 999 %}
                        {% if expiry_str and expiry_str < today %}
                            <span class="mono" style="color:var(--danger)">
                                {{ d.license_expiry }}
                                <i class="bi bi-x-circle-fill ms-1"></i>
                            </span>
                        {% elif days_left <= 30 %}
                            <span class="mono" style="color:var(--warning)">
                                {{ d.license_expiry }}
                                <i class="bi bi-exclamation-triangle-fill ms-1"></i>
                            </span>
                        {% else %}
                            <span class="mono" style="color:var(--success)">
                                {{ d.license_expiry }}
                            </span>
                        {% endif %}
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <span style="color:var(--text-secondary)">Category</span>
                        <span>{{ d.vehicle_category }}</span>
                    </div>
                </div>

                <!-- Actions -->
                <div class="d-flex gap-2">
                    {% if can_write_drivers %}
                    <button class="btn btn-sm flex-fill" style="border:1px solid var(--border);color:var(--text-secondary)"
                        data-bs-toggle="modal" data-bs-target="#editDriverModal{{ d.id }}">
                        <i class="bi bi-pencil me-1"></i>Edit
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-sm dropdown-toggle" style="border:1px solid var(--border);color:var(--text-secondary)" data-bs-toggle="dropdown">
                            Status
                        </button>
                        <ul class="dropdown-menu" style="background:var(--bg-card);border:1px solid var(--border)">
                            {% for status in ['On Duty', 'Off Duty', 'Suspended'] %}
                            <li>
                                <form method="POST" action="/drivers/toggle_status/{{ d.id }}">
                                    <input type="hidden" name="status" value="{{ status }}">
                                    <button type="submit" class="dropdown-item" style="color:var(--text-primary);font-size:0.82rem">
                                        {% if status == d.status %}<i class="bi bi-check me-2 text-accent"></i>{% else %}<span style="width:20px;display:inline-block"></span>{% endif %}
                                        {{ status }}
                                    </button>
                                </form>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <form method="POST" action="/drivers/delete/{{ d.id }}" onsubmit="return confirm('Remove this driver?')">
                        <button type="submit" class="btn btn-sm" style="border:1px solid var(--border);color:var(--danger)">
                            <i class="bi bi-trash3"></i>
                        </button>
                    </form>
                    {% else %}
                    <span style="font-size:0.75rem;color:var(--text-secondary);padding:6px 8px;background:var(--bg-elevated);border-radius:6px;width:100%;text-align:center">
                        <i class="bi bi-eye me-1"></i>View only
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if can_write_drivers %}
        <!-- Edit Modal -->
        <div class="modal fade" id="editDriverModal{{ d.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-person-badge me-2 text-accent"></i>Edit Driver: {{ d.name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="POST" action="/drivers/edit/{{ d.id }}">
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" name="name" class="form-control" value="{{ d.name }}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Phone</label>
                                    <input type="text" name="phone" class="form-control" value="{{ d.phone or '' }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="email" class="form-control" value="{{ d.email or '' }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Safety Score (0-100)</label>
                                    <input type="number" name="safety_score" class="form-control" value="{{ d.safety_score }}" min="0" max="100">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">License Number</label>
                                    <input type="text" name="license_number" class="form-control" value="{{ d.license_number }}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">License Expiry</label>
                                    <input type="date" name="license_expiry" id="editExpiry{{ d.id }}"
                                        class="form-control" value="{{ d.license_expiry }}"
                                        required oninput="checkEditExpiry(this, '{{ d.id }}')">
                                    <div id="editExpiryMsg{{ d.id }}" style="font-size:0.75rem;margin-top:5px;padding:6px 10px;border-radius:6px;display:none"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Vehicle Category</label>
                                    <select name="vehicle_category" class="form-select">
                                        <option {% if d.vehicle_category=='Any' %}selected{% endif %}>Any</option>
                                        <option {% if d.vehicle_category=='Truck' %}selected{% endif %}>Truck</option>
                                        <option {% if d.vehicle_category=='Van' %}selected{% endif %}>Van</option>
                                        <option {% if d.vehicle_category=='Bike' %}selected{% endif %}>Bike</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-sm" style="border:1px solid var(--border);color:var(--text-secondary)" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-sm btn-accent">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5" style="color:var(--text-secondary)">
                <i class="bi bi-person-badge" style="font-size:2rem;display:block;margin-bottom:8px"></i>
                No drivers added yet.
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if can_write_drivers %}
<!-- Add Driver Modal -->
<div class="modal fade" id="addDriverModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-badge me-2 text-accent"></i>Add New Driver</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/drivers/add">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Full Name</label>
                            <input type="text" name="name" class="form-control" required placeholder="e.g. Alex Johnson">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="text" name="phone" class="form-control" placeholder="9876543210">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control" placeholder="alex@example.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">License Number</label>
                            <input type="text" name="license_number" class="form-control" required placeholder="DL-2024-XXX">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">License Expiry Date</label>
                            <input type="date" name="license_expiry" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Vehicle Category</label>
                            <select name="vehicle_category" class="form-select">
                                <option>Any</option>
                                <option>Truck</option>
                                <option>Van</option>
                                <option>Bike</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm" style="border:1px solid var(--border);color:var(--text-secondary)" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-sm btn-accent"><i class="bi bi-plus-lg me-1"></i>Add Driver</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}