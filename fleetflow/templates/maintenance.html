{% extends 'base.html' %}
{% block extra_css %}
<style>
@media (max-width: 575px) {
    
    .data-table th:nth-child(4),
    .data-table td:nth-child(4) { display: none; } 
}
</style>
{% endblock %}
{% block title %}Maintenance Logs{% endblock %}
{% block page_title %}Maintenance & Service Logs{% endblock %}
{% block page_subtitle %}Preventative and reactive vehicle health tracking{% endblock %}

{% block topbar_actions %}
{% if can_write_maintenance %}
<button class="btn btn-accent btn-sm" data-bs-toggle="modal" data-bs-target="#addMaintenanceModal">
    <i class="bi bi-plus-lg me-1"></i>Log Service
</button>
{% else %}
<span class="badge" style="background:rgba(148,163,184,0.15);color:var(--text-secondary);padding:6px 12px;border-radius:6px;font-size:0.75rem"><i class="bi bi-eye me-1"></i>Read Only</span>
{% endif %}
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <i class="bi bi-wrench-adjustable me-2 text-accent"></i>Service History
        <span style="color:var(--text-secondary);font-weight:400;margin-left:8px;font-size:0.78rem">({{ logs|length }} records)</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Vehicle</th>
                        <th>Service Type</th>
                        <th>Description</th>
                        <th>Cost</th>
                        <th>Service Date</th>
                        <th>Mechanic</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>
                            <div style="font-weight:600">{{ log.vehicle_name or '—' }}</div>
                            <div class="mono" style="font-size:0.72rem;color:var(--text-secondary)">{{ log.license_plate or '' }}</div>
                        </td>
                        <td>
                            <span style="background:var(--bg-elevated);padding:3px 8px;border-radius:5px;font-size:0.78rem">
                                {{ log.service_type }}
                            </span>
                        </td>
                        <td style="max-width:200px;font-size:0.82rem;color:var(--text-secondary)">{{ log.description or '—' }}</td>
                        <td class="mono">₹{{ '{:,.0f}'.format(log.cost) }}</td>
                        <td>{{ log.service_date }}</td>
                        <td style="font-size:0.82rem">{{ log.mechanic or '—' }}</td>
                        <td>
                            {% if log.status == 'Ongoing' %}
                            <span class="status-pill pill-in-shop">Ongoing</span>
                            {% else %}
                            <span class="status-pill pill-completed">Completed</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.status == 'Ongoing' %}
                                {% if can_write_maintenance %}
                                <form method="POST" action="/maintenance/complete/{{ log.id }}">
                                    <button type="submit" class="btn btn-sm" style="border:1px solid var(--success);color:var(--success)" title="Mark Complete">
                                        <i class="bi bi-check-lg"></i> Done
                                    </button>
                                </form>
                                {% else %}
                                <span style="font-size:0.75rem;color:var(--text-secondary)"><i class="bi bi-eye me-1"></i>View only</span>
                                {% endif %}
                            {% else %}
                            <span style="color:var(--text-secondary);font-size:0.75rem">{{ log.completed_date or '' }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="9" class="text-center py-5" style="color:var(--text-secondary)">
                        <i class="bi bi-wrench" style="font-size:2rem;display:block;margin-bottom:8px"></i>
                        No maintenance records yet.
                    </td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if can_write_maintenance %}
<!-- Add Maintenance Modal -->
<div class="modal fade" id="addMaintenanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-wrench-adjustable me-2 text-accent"></i>Log New Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/maintenance/add">
                <div class="modal-body">
                    <div class="alert" style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);color:var(--warning);border-radius:8px;font-size:0.8rem">
                        <i class="bi bi-info-circle me-2"></i>Adding a service log will automatically set the vehicle status to <strong>In Shop</strong>.
                    </div>
                    <div class="row g-3 mt-1">
                        <div class="col-12">
                            <label class="form-label">Vehicle</label>
                            <select name="vehicle_id" class="form-select" required>
                                <option value="">— Select Vehicle —</option>
                                {% for v in vehicles %}
                                <option value="{{ v.id }}">{{ v.name }} ({{ v.license_plate }}) — {{ v.status }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-7">
                            <label class="form-label">Service Type</label>
                            <select name="service_type" class="form-select">
                                <option>Oil Change</option>
                                <option>Tyre Replacement</option>
                                <option>Engine Overhaul</option>
                                <option>Brake Service</option>
                                <option>AC Repair</option>
                                <option>Electrical</option>
                                <option>General Inspection</option>
                                <option>Transmission Service</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-5">
                            <label class="form-label">Cost (₹)</label>
                            <input type="number" name="cost" class="form-control" placeholder="0" step="0.01">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Description</label>
                            <textarea name="description" class="form-control" rows="2" placeholder="Detailed description of service..."></textarea>
                        </div>
                        <div class="col-12 col-sm-6">
                            <label class="form-label">Service Date</label>
                            <input type="date" name="service_date" class="form-control" value="{{ now }}" required>
                        </div>
                        <div class="col-12 col-sm-6">
                            <label class="form-label">Mechanic / Workshop</label>
                            <input type="text" name="mechanic" class="form-control" placeholder="e.g. Raju Auto Works">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm" style="border:1px solid var(--border);color:var(--text-secondary)" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-sm btn-accent"><i class="bi bi-plus-lg me-1"></i>Log Service</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.querySelector('input[name="service_date"]');
    if (dateInput && !dateInput.value) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
});
</script>

{% endblock %}